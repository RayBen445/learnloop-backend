// LearnLoop Backend - Prisma Schema
// A human-first learning social app for students
// Phase 1: Database design only (no routes, controllers, or auth yet)

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ====================
// USER MODEL
// ====================
// Stores user accounts with authentication and gamification
// - UUID for better security and scalability
// - learningScore tracks user engagement and quality contributions
model User {
  id             String   @id @default(uuid()) @db.Uuid
  email          String   @unique
  username       String   @unique
  hashedPassword String
  learningScore  Int      @default(0)
  isAdmin        Boolean  @default(false) // Phase 8: Admin flag for moderation
  createdAt      DateTime @default(now())

  // Relations
  posts      Post[]
  comments   Comment[]
  savedPosts SavedPost[]
  votes      Vote[]
  reports    Report[]

  @@index([email])
  @@index([username])
  @@map("users")
}

// ====================
// TOPIC MODEL
// ====================
// Categorizes posts by subject area
// - Each post must have exactly ONE primary topic
// - Topics are predefined to ensure consistency
model Topic {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String
  createdAt   DateTime @default(now())

  // Relations
  posts Post[]

  @@index([name])
  @@map("topics")
}

// ====================
// POST MODEL
// ====================
// User-generated learning content
// - Soft delete support via deletedAt field
// - Title limited to 60 chars (enforced at API layer)
// - Content 80-220 words (enforced at API layer)
// - Exactly ONE primary topic per post
model Post {
  id             Int       @id @default(autoincrement())
  title          String    @db.VarChar(60)
  content        String    @db.Text
  authorId       String    @db.Uuid
  primaryTopicId Int
  isHidden       Boolean   @default(false) // Phase 8: Soft hide for moderation
  createdAt      DateTime  @default(now())
  deletedAt      DateTime? // Soft delete support

  // Relations
  author       User        @relation(fields: [authorId], references: [id], onDelete: Cascade)
  primaryTopic Topic       @relation(fields: [primaryTopicId], references: [id], onDelete: Restrict)
  comments     Comment[]
  savedBy      SavedPost[]
  votes        Vote[]
  reports      Report[]

  @@index([authorId])
  @@index([primaryTopicId])
  @@index([createdAt])
  @@index([deletedAt]) // For efficient filtering of deleted posts
  @@index([isHidden]) // Phase 8: For efficient filtering of hidden posts
  @@map("posts")
}

// ====================
// COMMENT MODEL
// ====================
// User comments on posts
// - Minimum 20 characters (enforced at API layer)
// - No nesting/threading in Phase 1
model Comment {
  id        Int      @id @default(autoincrement())
  content   String   @db.Text
  authorId  String   @db.Uuid
  postId    Int
  isHidden  Boolean  @default(false) // Phase 8: Soft hide for moderation
  createdAt DateTime @default(now())

  // Relations
  author  User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  post    Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  votes   Vote[]
  reports Report[]

  @@index([authorId])
  @@index([postId])
  @@index([createdAt])
  @@index([isHidden]) // Phase 8: For efficient filtering of hidden comments
  @@map("comments")
}

// ====================
// SAVEDPOST MODEL
// ====================
// Allows users to save/bookmark posts
// - Composite primary key prevents duplicate saves
model SavedPost {
  userId  String   @db.Uuid
  postId  Int
  savedAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@id([userId, postId])
  @@index([userId])
  @@index([postId])
  @@map("saved_posts")
}

// ====================
// VOTE MODEL
// ====================
// Upvote-only system for posts and comments
// - Users can vote on either a post OR a comment (not both)
// - Unique constraints prevent duplicate votes on posts and comments separately
// - type field is enum with only "UPVOTE" to support future vote types if needed
// 
// NOTE: Application logic MUST ensure exactly one of postId or commentId is non-null.
// The unique constraints work correctly because NULL values are treated as distinct in PostgreSQL.
// - @@unique([userId, postId]) prevents duplicate votes on the same post
// - @@unique([userId, commentId]) prevents duplicate votes on the same comment
model Vote {
  id        Int      @id @default(autoincrement())
  userId    String   @db.Uuid
  postId    Int?
  commentId Int?
  type      VoteType @default(UPVOTE)
  votedAt   DateTime @default(now())

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post    Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  comment Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  // Prevent duplicate votes on posts
  @@unique([userId, postId])
  // Prevent duplicate votes on comments
  @@unique([userId, commentId])
  @@index([userId])
  @@index([postId])
  @@index([commentId])
  @@map("votes")
}

// ====================
// REPORT MODEL
// ====================
// Phase 8: User reports for content moderation
// - Users can report posts or comments (exactly one)
// - Prevents duplicate reports by same user on same content
// - When >= 5 reports, content is automatically hidden
model Report {
  id        Int          @id @default(autoincrement())
  reporterId String      @db.Uuid
  postId    Int?
  commentId Int?
  reason    ReportReason
  details   String?      @db.Text
  createdAt DateTime     @default(now())

  // Relations
  reporter User     @relation(fields: [reporterId], references: [id], onDelete: Cascade)
  post     Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  comment  Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  // Prevent duplicate reports by same user on same post
  @@unique([reporterId, postId])
  // Prevent duplicate reports by same user on same comment
  @@unique([reporterId, commentId])
  @@index([postId])
  @@index([commentId])
  @@index([createdAt])
  @@map("reports")
}

// ====================
// ENUMS
// ====================
enum VoteType {
  UPVOTE
}

enum ReportReason {
  SPAM
  INAPPROPRIATE
  HARASSMENT
  MISINFORMATION
  OFF_TOPIC
  OTHER
}
